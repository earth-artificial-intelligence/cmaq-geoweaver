[{
  "history_id" : "4uvx7qa30l4",
  "history_input" : "# Write first python in Geoweaver# NASA GEOWEAVER\n# CMAQ-AI Model: Training Voting-XGBoost model\n\n# Importing necessary libraries\nimport pandas as pd\nimport sklearn\nfrom sklearn.ensemble import RandomForestRegressor\nfrom xgboost.sklearn import XGBRegressor\nimport pickle\nfrom cmaq_ai_utils import *\n\nfrom sklearn.preprocessing import MinMaxScaler\n\n# importing data\nfinal = pd.read_csv(f'{cmaq_folder}/training.csv')\nprint(final.head())\nfinal = final.dropna()\n\n# Initialize a normalizer\n# scaler = MinMaxScaler(feature_range=(0, 1))\n# final[final.columns] = scaler.fit_transform(final)\n\n# Make coords coarse by removing decimals\nfinal['Latitude_coarse'] = round(final['Latitude'])\nfinal['Longitude_coarse'] = round(final['Longitude'])\n\n# Split time of day into value ranges.\n# Hours 0 - 3 is value 1 (Midnight), 4 - 7 is value 2 (Early Morning), 8 - 11 is value 3 (Morning), 12 - 15 is value 4 (Noon), 16 - 19 is value 5 (Evening), 20 - 23 is value 6 (Night)\nfinal['time_of_day'] = (final['hours'] % 24 + 4) // 4\n\n# Make coords even more coarse by rounding to closest multiple of 5 \n# (e.g., 40, 45, 85, 55)\n# final['Latitude'] = 5 * round(final['Latitude']/5)\n# final['Longitude'] = 5 * round(final['Longitude']/5)\n\ncreate_and_clean_folder(f\"{cmaq_folder}/models/\")\n\n# Processing training  data\nX = final.drop(['AirNOW_O3', 'Latitude', 'Longitude',  'CMAQ12KM_CO(ppm)', 'CMAQ_OC(ug/m3)', 'CO(moles/s)',\n               'PRSFC(Pa)', 'PBL(m)', 'TEMP2(K)', 'WSPD10(m/s)', 'WDIR10(degree)', 'RGRND(W/m2)', 'CFRAC', 'month', 'day', 'hours'], axis=1)\nprint(\"input shape:\", X.shape)\ny = final['AirNOW_O3']\nprint(\"used as inputs: \", X.columns)\nrf = RandomForestRegressor(bootstrap=False, ccp_alpha=0.0, criterion='mse',\n                           max_depth=None, max_features='auto', max_leaf_nodes=None,\n                           max_samples=None, min_impurity_decrease=0.0,\n                           min_samples_leaf=1,\n                           min_samples_split=2, min_weight_fraction_leaf=0.0,\n                           n_estimators=100, n_jobs=-1, oob_score=False,\n                           random_state=3086, verbose=0, warm_start=False)\n\nrf.fit(X, y)\n\n# save the model to disk\nfilename = f'{cmaq_folder}/models/rf_pycaret_o3_only.sav'\n#filename = 'D:/Research/CMAQ/local_test/xgboost.sav'\npickle.dump(rf, open(filename, 'wb'))\n",
  "history_output" : "    Latitude  Longitude  AirNOW_O3  CMAQ12KM_O3(ppb)  ...  CFRAC  month  day  hours\n0  30.260300 -81.453300       14.0              21.0  ...    0.0      8    5     12\n1  42.770802 -71.102798       40.0              25.0  ...    0.0      8    5     12\n2  34.528599 -86.970596        8.0              14.0  ...    0.0      8    5     12\n3  42.194401 -72.555603       23.0              25.0  ...    0.0      8    5     12\n4  34.751801 -82.256699        8.0              17.0  ...    0.0      8    5     12\n\n[5 rows x 18 columns]\ninput shape: (55900, 5)\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\n/home/aalnaim/CMAQAI/lib/python3.8/site-packages/sklearn/ensemble/_forest.py:396: FutureWarning: Criterion 'mse' was deprecated in v1.0 and will be removed in version 1.2. Use `criterion='squared_error'` which is equivalent.\n  warn(\n",
  "history_begin_time" : 1660969359712,
  "history_end_time" : 1660973594854,
  "history_notes" : null,
  "history_process" : "1mq84p",
  "host_id" : "p6wvf2",
  "indicator" : "Stopped"
},{
  "history_id" : "2zpcqpjxm9n",
  "history_input" : "# load the prediction_rf.csv into a NetCDF file for visualization\nfrom cmaq_ai_utils import *\n\n\n# end_date = datetime.today()\n# base = end_date - timedelta(days=2)\nsdate = date(2022, 8, 5)   # start date\nedate = date(2022, 8, 6)   # end date\ndays = get_days_list(sdate, edate)\n\nprediction_path = f\"{cmaq_folder}prediction_files/\"\ncreate_and_clean_folder(f\"{cmaq_folder}/prediction_nc_files/\")\n\n# df_csv['YYYYMMDDHH'] = df_csv['YYYYMMDDHH'].astype(str)\n# print(df_csv['YYYYMMDDHH'].unique())\n# df_filt = df_csv[df_csv['YYYYMMDDHH'].str.contains(days[1]+\"|\"+days[0]+\"|\"+days[2], case = False, regex=True)] #this line seems unnecessary\n# df_filt = df_filt[(df_filt['YYYYMMDDHH'] > days[0]+'11') & (df_filt['YYYYMMDDHH'] < days[1]+'12')]\n# print(df_filt['YYYYMMDDHH'].unique())\n\n# Reshape \"prediction/Latitude/Longitude\" columns to (TSTEP, ROW, COL), these lines will reshape data into (24, 265, 442)\n#reshaped_prediction = np.atleast_3d(df_filt['prediction']).reshape(-1, 265, 442)\n\nall_hourly_files = sorted(glob.glob(os.path.join(prediction_path, \"*.csv\")))\nprint(\"overall hourly files: \", all_hourly_files)\n\nfor i in range(1):\n    print(days[i])\n\n    df_cdf = xr.open_dataset(\n        \"/groups/ESS/share/projects/SWUS3km/data/cmaqdata/CCTMout/12km/POST/COMBINE3D_ACONC_v531_gcc_AQF5X_\" + days[i + 1] + \"_extracted.nc\")\n\n    print(\"single day hourly files: \", all_hourly_files[i * 24:(i + 1) * 24])\n    df_from_each_hourly_file = (pd.read_csv(f)\n                                for f in all_hourly_files[i * 24:(i + 1) * 24])\n\n    df_csv = pd.concat(df_from_each_hourly_file, ignore_index=True)\n\n    reshaped_prediction = df_csv['prediction'].to_numpy().reshape(24, 265, 442)\n    print(reshaped_prediction.shape)\n\n    # Remove \"LAY\" Dimension in O3 variable already in nc file.\n    reduced_dim = df_cdf['O3'].sel(LAY=1, drop=True)\n\n    # Swap values from original nc file with new prediction data\n    reduced_dim.values = reshaped_prediction\n\n    # Apply changes to data variable in nc file\n    df_cdf['O3'] = (['TSTEP', 'ROW', 'COL'], reshaped_prediction)\n    df_cdf = df_cdf[['O3', 'TFLAG']]\n    \n#   create_and_clean_folder(f\"{cmaq_folder}/prediction_nc_files\")\n    df_cdf.to_netcdf(\n        f'{cmaq_folder}prediction_nc_files/COMBINE3D_ACONC_v531_gcc_AQF5X_' + days[i] + '_ML_extracted.nc')\n\n    print(\n        f'Saved updated netCDF file: {cmaq_folder}prediction_nc_files/COMBINE3D_ACONC_v531_gcc_AQF5X_' + days[i] + '_ML_extracted.nc')\n",
  "history_output" : "overall hourly files:  ['/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080512.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080513.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080514.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080515.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080516.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080517.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080518.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080519.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080520.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080521.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080522.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080523.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080600.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080601.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080602.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080603.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080604.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080605.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080606.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080607.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080608.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080609.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080610.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080611.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080612.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080613.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080614.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080615.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080616.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080617.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080618.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080619.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080620.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080621.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080622.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080623.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080700.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080701.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080702.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080703.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080704.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080705.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080706.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080707.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080708.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080709.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080710.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080711.csv']\n20220805\nsingle day hourly files:  ['/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080512.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080513.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080514.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080515.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080516.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080517.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080518.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080519.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080520.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080521.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080522.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080523.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080600.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080601.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080602.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080603.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080604.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080605.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080606.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080607.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080608.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080609.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080610.csv', '/groups/ESS/aalnaim/cmaq/prediction_files/prediction_rf_2022080611.csv']\n(24, 265, 442)\nSaved updated netCDF file: /groups/ESS/aalnaim/cmaq/prediction_nc_files/COMBINE3D_ACONC_v531_gcc_AQF5X_20220805_ML_extracted.nc\n",
  "history_begin_time" : 1660969494563,
  "history_end_time" : 1660973594856,
  "history_notes" : null,
  "history_process" : "eq05y9",
  "host_id" : "p6wvf2",
  "indicator" : "Stopped"
},{
  "history_id" : "yelmuir3rx9",
  "history_input" : "#!/bin/bash\n# generate images and gif from the NetCDF files\n\ncmaq_folder=\"/groups/ESS/aalnaim/cmaq\"\nmkdir $cmaq_folder\"/plots\"\nrm $cmaq_folder/plots/* # clean everything first\n\necho $(date -d '2 day ago' '+%Y%m%d')\n# Setting env variables\n#export YYYYMMDD_POST=$(date -d '2 day ago' '+%Y%m%d') #This needs to be auto date `date -d \"-2 day ${1}\" +%Y%m%d`\nexport YYYYMMDD_POST='20220805'\n#export stdate_post=$(date -d '2 day ago' '+%Y-%m-%d') #This needs to be auto date\nexport stdate_post='2022-08-05'\n#export eddate_post=$(date -d '1 day ago' '+%Y-%m-%d') #This needs to be auto date\nexport eddate_post='2022-08-06'\n\n#export stdate_file=$(date -d '2 day ago' '+%Y%m%d') #This needs to be auto date\nexport stdate_file='20220805'\n#export eddate_file=$(date -d '1 day ago' '+%Y%m%d') #This needs to be auto date\nexport eddate_file='20220806'\n\n\nexport postdata_dir=$cmaq_folder\"/prediction_nc_files\"\nexport mcip_dir=\"/groups/ESS/share/projects/SWUS3km/data/cmaqdata/mcip/12km\"\nexport dir_graph=$cmaq_folder\"/plots\"\n\nmodule load ncl\n\nrm $cmaq_folder/geoweaver_plot_daily_O3.ncl\ncat <<EOF >> $cmaq_folder/geoweaver_plot_daily_O3.ncl\nload \"/opt/sw/spack/apps/linux-centos8-cascadelake/gcc-9.3.0-openmpi-4.0.4/ncl-6.6.2-fr/lib/ncarg/nclscripts/csm/gsn_code.ncl\"\nload \"/opt/sw/spack/apps/linux-centos8-cascadelake/gcc-9.3.0-openmpi-4.0.4/ncl-6.6.2-fr/lib/ncarg/nclscripts/csm/gsn_csm.ncl\"\nload \"/opt/sw/spack/apps/linux-centos8-cascadelake/gcc-9.3.0-openmpi-4.0.4/ncl-6.6.2-fr/lib/ncarg/nclscripts/csm/contributed.ncl\"\n\nsetvalues NhlGetWorkspaceObjectId()\n\"wsMaximumSize\": 600000000\nend setvalues\n\nbegin\n\ndate = getenv(\"YYYYMMDD_POST\")\nd1 = getenv(\"stdate_post\")\nd2 = getenv(\"eddate_post\")\n\ndFile1 = getenv(\"stdate_file\")\ndFile2 = getenv(\"eddate_file\")\n\n;print(\"Passed Date: \"+date)\n\n;aconc_dir = getenv(\"postdata_dir\")\ngrid_dir = getenv(\"mcip_dir\")\nplot_dir = getenv(\"dir_graph\")\n\nprint(\"/groups/ESS/aalnaim/cmaq/prediction_nc_files/COMBINE3D_ACONC_v531_gcc_AQF5X_\"+dFile1+\"_ML_extracted.nc\")\ncdf_file1 = addfile(\"/groups/ESS/aalnaim/cmaq/prediction_nc_files/COMBINE3D_ACONC_v531_gcc_AQF5X_\"+dFile1+\"_ML_extracted.nc\",\"r\")\ncdf_file= addfile(grid_dir+\"/GRIDCRO2D_\"+date+\".nc\",\"r\")\n\nptime = (/\"12\",\"13\",\"14\",\"15\",\"16\",\"17\",\"18\",\"19\",\"20\",\"21\",\"22\",\"23\",\"00\",\"01\",\"02\",\"03\",\"04\",\"05\",\"06\",\"07\",\"08\",\"09\",\"10\",\"11\"/)\n\ntime = cdf_file1->TFLAG(:,0,:)\no3 = cdf_file1->O3(:,:,:) ;ppb\n;pm25 = cdf_file1->PM25_TOT(:,0,:,:)\n\n\nnt = dimsizes(o3(:,0,0))\nny = dimsizes(o3(0,:,0))\nnx = dimsizes(o3(0,0,:))\n\nprint(nt+\" \"+ny+\" \"+nx)\nprint(max(o3))\nprint(min(o3))\nprint(avg(o3))\n\n;print(max(pm25))\n;print(min(pm25))\n;print(avg(pm25))\n\n;print(time)\n\nlat = cdf_file->LAT(0,0,:,:)\nlon = cdf_file->LON(0,0,:,:)\n\no3@lat2d = lat\no3@lon2d = lon\n\nres = True\nres@gsnMaximize = True                ; maximize pot in frame\nres@gsnFrame = False               ; don't advance frame\nres@gsnDraw = False\n;res@gsnSpreadColors = True\nres@lbLabelAutoStride = True\n;res@lbBoxLinesOn = False\nres@pmLabelBarHeightF = 0.1\nres@pmLabelBarWidthF = 0.5\nres@cnFillOn=True\n;res@cnMonoFillPattern=True\n;res@cnMonoLineColor=True\nres@cnLinesOn=False\n;res@pmLabelBarDisplayMode=\"never\"\nres@gsnLeftString  = \"\";\nres@gsnRightString = \"\"\n\nres@mpLimitMode = \"LatLon\"\nres@mpMinLonF = -120 ;min(lon)+0.2\nres@mpMaxLonF = -70 ;max(lon)-0.2\nres@mpMinLatF = 25 ;min(lat)+0.05\nres@mpMaxLatF = 50 ;max(lat)-0.05\nres@mpDataBaseVersion = \"MediumRes\"\n;res@tiMainString = times(it)\nres@mpDataBaseVersion       = \"MediumRes\"\nres@mpDataSetName           = \"Earth..4\"\nres@mpAreaMaskingOn         = True\nres@mpOutlineBoundarySets = \"GeophysicalAndUSStates\"\nres@mpOutlineSpecifiers=\"United States : States\"\nres@mpLandFillColor         = \"white\"\nres@mpInlandWaterFillColor  = \"white\"\nres@mpOceanFillColor        = \"white\"\nres@mpGeophysicalLineColor    = \"Black\"\nres@mpGeophysicalLineThicknessF = 1.5\n\n;res@gsnSpreadColors         = True\nres@lbLabelAutoStride       = True\nres@lbLabelFont             = 25\nres@tiXAxisFont             = 25\nres@pmTickMarkDisplayMode   = \"Always\"\nres@tmXBLabelFont           = 25\nres@tmXBLabelFontHeightF    = 0.013\nres@tmXBLabelDeltaF         = -0.5\nres@tmYLLabelFont           = 25\nres@tmYLLabelFontHeightF    = 0.013\nres@tmXBLabelDeltaF         = -0.5\nres@tmXTLabelsOn            = False\nres@tmXTLabelFont           = 25\nres@tmXTLabelFontHeightF    = 0.013\nres@tmYRLabelsOn            = False\nres@tmYRLabelFont           = 25\nres@tmYRLabelFontHeightF    = 0.013\n\n\nres@mpProjection           = \"LambertConformal\" ;\"CylindricalEquidistant\"\nres@mpLambertParallel1F    = 33.\nres@mpLambertParallel2F    = 45.\nres@mpLambertMeridianF     = -98.\n\nres@cnLevelSelectionMode = \"ManualLevels\"\nres@cnMinLevelValF          = 0.\nres@cnMaxLevelValF          = 80\nres@cnLevelSpacingF         = 4\n\nres@txFont   = \"times-roman\"\nres@tiMainFont   = \"times-roman\"\n\ndo it = 0, nt-1\n  if (it .lt. 12) then\n    pdate=d1\n  else\n    pdate=d2\n  end if\n\n  pname=plot_dir+\"/testPlot_\"+pdate+\"_\"+ptime(it)\n  wks = gsn_open_wks(\"png\",pname)\n  gsn_define_colormap(wks, \"WhiteBlueGreenYellowRed\")\n\n  res@tiMainString = pdate+\" \"+ptime(it)+\" UTC O~B~3~N~ Forecast (ppbV)\"\n  plot = gsn_csm_contour_map(wks,o3(it,:,:),res)\n  draw(plot)\n  frame(wks)\n  delete(wks)\n  system(\"composite -geometry 100x70+900+900 /groups/ESS/zsun/cmaq/mason-logo-green.png \"+pname+\".png \"+pname+\".png\")\nend do\ndelete(res)\n\nend\nEOF\n\n\nncl $cmaq_folder/geoweaver_plot_daily_O3.ncl\n\n# convert -delay 100 *.png 20220613_20220614.gif\nconvert -delay 100 $cmaq_folder/plots/testPlot*.png $cmaq_folder/plots/\"Map_\"$YYYYMMDD_POST.gif\n\nif [ $? -eq 0 ]; then\n    echo \"Generating images/gif Completed Successfully\"\nelse\n    echo \"Generating images/gif Failed!\"\nfi\n",
  "history_output" : "mkdir: cannot create directory ‘/groups/ESS/aalnaim/cmaq/plots’: File exists\n20220818\n Copyright (C) 1995-2019 - All Rights Reserved\n University Corporation for Atmospheric Research\n NCAR Command Language Version 6.6.2\n The use of this software is governed by a License Agreement.\n See http://www.ncl.ucar.edu/ for more details.\n(0)\t/groups/ESS/aalnaim/cmaq/prediction_nc_files/COMBINE3D_ACONC_v531_gcc_AQF5X_20220805_ML_extracted.nc\n(0)\t24 265 442\n(0)\t 109\n(0)\t  -4\n(0)\t26.84546006653082\n",
  "history_begin_time" : 1660969521416,
  "history_end_time" : 1660973594859,
  "history_notes" : null,
  "history_process" : "iicy7w",
  "host_id" : "p6wvf2",
  "indicator" : "Stopped"
},{
  "history_id" : "9ad6lxib2g2",
  "history_input" : null,
  "history_output" : null,
  "history_begin_time" : null,
  "history_end_time" : 1660973594868,
  "history_notes" : null,
  "history_process" : "is1w3m",
  "host_id" : "p6wvf2",
  "indicator" : "Stopped"
},{
  "history_id" : "9bhmgydtxd2",
  "history_input" : null,
  "history_output" : null,
  "history_begin_time" : null,
  "history_end_time" : 1660973594873,
  "history_notes" : null,
  "history_process" : "fsk7f2",
  "host_id" : "p6wvf2",
  "indicator" : "Stopped"
},{
  "history_id" : "sdzpviknowh",
  "history_input" : "# All the utility functions that most steps in CMAQ-AI need\n# this file should not contain any direct call of function\n# it should be dedicated to define functions or variables\n\nimport xarray as xr\nimport pandas as pd\nimport glob, os\nimport numpy as np\nfrom pathlib import Path\nfrom datetime import date, datetime, timedelta\nimport matplotlib.pyplot as plt\n\n# home directory\nhome = str(Path.home())\ncmaq_folder = \"/groups/ESS/aalnaim/cmaq/\" # change if you want to use your own folder\n\ndef get_days_list(sdate, edate):\n  days=[]\n  \n  delta = edate - sdate       # as timedelta\n\n  for i in range(delta.days + 1):\n    day = sdate + timedelta(days=i)\n    list_day=day.strftime('%Y%m%d')\n    days.append(list_day)\n  # add one more day\n  one_more_day = sdate + timedelta(days=delta.days + 1)\n  list_day=one_more_day.strftime('%Y%m%d')\n  days.append(list_day)\n  \n  return days\n\ndef create_and_clean_folder(folder_path):\n  os.makedirs(folder_path, exist_ok=True)\n  # clean all files inside the folder\n  for f in os.listdir(folder_path):\n    os.remove(os.path.join(folder_path, f))\n\ndef remove_file(file_path):\n  print(f'remove old files{file_path}')\n  if os.path.exists(file_path):\n    os.remove(file_path)\n    \ndef turn_2_digits(a):\n  return f\"{a:02}\"",
  "history_output" : "Running",
  "history_begin_time" : 1660969362501,
  "history_end_time" : 1660973594879,
  "history_notes" : null,
  "history_process" : "h76ld0",
  "host_id" : "p6wvf2",
  "indicator" : "Stopped"
},{
  "history_id" : "ipym097pata",
  "history_input" : "# use the trained model to predict on the testing data and save the results to prediction_rf.csv\n\nimport pandas as pd\nimport pickle\nfrom pathlib import Path\nfrom time import sleep\nimport glob\nimport os\nfrom sklearn.metrics import r2_score, mean_squared_error\nfrom cmaq_ai_utils import *\nfrom sklearn.preprocessing import MinMaxScaler\n\ncreate_and_clean_folder(f\"{cmaq_folder}/prediction_files/\")\n\n# scaler = MinMaxScaler(feature_range=(0, 1))\n\n# importing data\n# final=pd.read_csv(f\"{cmaq_folder}/testing_input_hourly/testing.csv\")\ntesting_path = f'{cmaq_folder}/testing_input_hourly'\nall_hourly_files = glob.glob(os.path.join(testing_path, \"test_data_*.csv\"))\ndf_from_each_hourly_file = (pd.read_csv(f) for f in all_hourly_files)\n\n# load the model from disk\n# filename = f'{cmaq_folder}/models/rf_pycaret.sav'\n\nfilename = f'{cmaq_folder}/models/rf_pycaret_o3_only.sav'\nloaded_model = pickle.load(open(filename, 'rb'))\n\nfor testing_df in df_from_each_hourly_file:\n    #   print(testing_df['YYYYMMDDHH'].values[0])\n    file_dateTime = testing_df['YYYYMMDDHH'].values[0]\n    # Make coords coarse by removing decimals\n    testing_df['Latitude_coarse'] = round(testing_df['Latitude'])\n    testing_df['Longitude_coarse'] = round(testing_df['Longitude'])\n    \n    # Split time of day into value ranges.\n    # Hours 0 - 3 is value 1 (Midnight), 4 - 7 is value 2 (Early Morning), 8 - 11 is value 3 (Morning), 12 - 15 is value 4 (Noon), 16 - 19 is value 5 (Evening), 20 - 23 is value 6 (Night)\n    testing_df['time_of_day'] = (testing_df['hours'] % 24 + 4) // 4\n    \n    X = testing_df.drop(['YYYYMMDDHH', 'Latitude', 'Longitude', 'CMAQ12KM_CO(ppm)', 'CMAQ_OC(ug/m3)', 'CO(moles/s)',\n               'PRSFC(Pa)', 'PBL(m)', 'TEMP2(K)', 'WSPD10(m/s)', 'WDIR10(degree)', 'RGRND(W/m2)', 'CFRAC', 'month', 'day', 'hours'], axis=1)\n    \n#     X[X.columns] = scaler.fit_transform(X)\n    \n    print(\"used as inputs: \", X.columns)\n# # making prediction\n    pred = loaded_model.predict(X)\n\n\n# adding prediction values to test dataset\n    testing_df['prediction'] = pred.tolist()\n\n    testing_df = testing_df[['Latitude',\n                             'Longitude', 'YYYYMMDDHH', 'prediction']]\n# saving the dataset into local drive\n    print(\n        f'Saving: {cmaq_folder}/prediction_files/prediction_rf_{file_dateTime}.csv')\n    testing_df.to_csv(\n        f'{cmaq_folder}/prediction_files/prediction_rf_{file_dateTime}.csv', index=False)\n\n    \n  \nimp = loaded_model.feature_importances_\nfeature_names = [i for i in X.columns]\nstd = np.std([tree.feature_importances_ for tree in loaded_model.estimators_], axis=0)\nforest_importances = pd.Series(imp, index=feature_names)\n\nusedInputs = \", \".join(X.columns)\n\nfig, ax = plt.subplots(figsize=(15, 10))\nforest_importances.plot.barh(yerr=std, ax=ax)\nax.set_title(\"Model Inputs: \"+usedInputs, fontsize=14)\nfig.suptitle(\"Feature importances\", fontsize=16)\nax.set_xlabel(\"Mean decrease in impurity\")\nplt.savefig(cmaq_folder+\"/featImp/rf_importance_20220805_Inputs.png\")",
  "history_output" : "used as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080608.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080601.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080606.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080705.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080617.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080610.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080521.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080702.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080619.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080514.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080513.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080622.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080607.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080600.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080609.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080512.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080623.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080515.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080618.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080611.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080520.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080703.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080704.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080616.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080516.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080620.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080518.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080709.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080707.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080615.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080612.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080523.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080700.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080603.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080711.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080604.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080613.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080522.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080701.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080706.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080614.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080708.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080519.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080621.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080517.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080605.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080602.csv\nused as inputs:  Index(['CMAQ12KM_O3(ppb)', 'CMAQ12KM_NO2(ppb)', 'Latitude_coarse',\n       'Longitude_coarse', 'time_of_day'],\n      dtype='object')\nSaving: /groups/ESS/aalnaim/cmaq//prediction_files/prediction_rf_2022080710.csv\n",
  "history_begin_time" : 1660969414751,
  "history_end_time" : 1660973594880,
  "history_notes" : null,
  "history_process" : "zbw9k8",
  "host_id" : "p6wvf2",
  "indicator" : "Stopped"
}]
